name: PR Summary Generator

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  summarize:
    runs-on: ubuntu-latest
    steps:
      - name: Install Ollama
        uses: ai-action/setup-ollama@v1
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Generate PR Summary
        run: |
          # Pull a free model (e.g., codellama for code summarization)
          ollama pull codellama
          
          # Get the PR diff
          PR_DIFF=$(gh pr diff ${{ github.event.pull_request.number }})
          
          # Inline prompt: Customize this string as needed
          PROMPT="Summarize the following code changes in a concise bullet-point list. Focus on key additions, removals, and potential impacts:\n\n$PR_DIFF"
          
          # Generate summary using the model
          PR_SUMMARY=$(ollama run codellama "$PROMPT")
          
          # Prepend or append the summary to the existing PR body (adjust as desired)
          EXISTING_BODY=$(gh pr view ${{ github.event.pull_request.number }} --json body --jq .body)
          NEW_BODY="### AI-Generated Summary\n$PR_SUMMARY\n\n$EXISTING_BODY"
          
          # Update the PR description
          gh pr edit ${{ github.event.pull_request.number }} --body "$NEW_BODY"
        env:
          GITHUB_TOKEN: ${{ github.token }}
